<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WiFi León - Acceso Total</title>
    <style>
        body { font-family: sans-serif; background-color: #050505; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .card { background: #1a1a1a; padding: 25px; border-radius: 15px; text-align: center; width: 100%; max-width: 380px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn-acceso { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; padding: 18px; font-size: 18px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; transition: transform 0.2s; }
        .btn-acceso:active { transform: scale(0.98); }
        .btn-acceso:disabled { background: #333; color: #777; }
        
        #debug-box { margin-top: 20px; padding: 15px; background: #000; color: #00ff41; font-family: 'Courier New', monospace; font-size: 10px; border: 1px solid #00ff41; border-radius: 5px; width: 100%; max-width: 380px; box-sizing: border-box; }
        .line { border-bottom: 1px solid #111; padding: 4px 0; display: flex; justify-content: space-between; }
        .val { color: #fff; text-align: right; max-width: 60%; word-break: break-all; }
        #status-bar { font-size: 12px; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <h2 style="margin-top:0;">WiFi León</h2>
        <p style="color: #aaa; font-size: 14px;">Acceso Gratuito a Internet</p>
        <button id="connectBtn" class="btn-acceso">CONECTAR AHORA</button>
        <div id="status-bar"></div>
    </div>

    <div id="debug-box">
        <div style="text-align:center; font-weight:bold; color:#00ff41; margin-bottom:10px;">DEBUG CONSOLE V5 (REDUNDANT AUTH)</div>
        <div class="line"><span>AP MAC:</span> <span class="val" id="d-ap">-</span></div>
        <div class="line"><span>CL MAC:</span> <span class="val" id="d-cm">-</span></div>
        <div class="line"><span>SESSION:</span> <span class="val" id="d-qv">-</span></div>
        <div class="line"><span>NET TEST:</span> <span class="val" id="d-net">Checking...</span></div>
        <div class="line"><span>LAST ERROR:</span> <span class="val" id="d-err" style="color: #ffea00;">None</span></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // CONSTANTES
            const KEY = "1ccf7c8b0813cd1cb25d766b2d98ef854e68fa4e1633e99f570ec300ee2ac7ae";
            const URL_API = "https://us-e1.api.cloud.cambiumnetworks.com/api/v2/easypass/external-portal/login";
            const SUCCESS = "https://empleo.leon.gob.mx";

            const btn = document.getElementById('connectBtn');
            const statusBar = document.getElementById('status-bar');
            const dNet = document.getElementById('d-net');
            const dErr = document.getElementById('d-err');

            // 1. CAPTURA DE URL
            const params = new URLSearchParams(window.location.search);
            const ga_ap_mac = params.get('ga_ap_mac') || params.get('ap_mac') || "";
            const ga_cmac = params.get('ga_cmac') || params.get('client_mac') || "";
            const ga_Qv = params.get('s') || params.get('ga_Qv') || "";

            document.getElementById('d-ap').innerText = ga_ap_mac || "Missing";
            document.getElementById('d-cm').innerText = ga_cmac || "Missing";
            document.getElementById('d-qv').innerText = ga_Qv ? "Capturado OK" : "EMPTY";

            // 2. PRE-CHECK DE RED (Walled Garden Test)
            (async () => {
                try {
                    await fetch(URL_API, { method: 'OPTIONS', mode: 'cors' });
                    dNet.innerText = "ALCANZABLE";
                    dNet.style.color = "#00ff41";
                } catch (e) {
                    dNet.innerText = "BLOQUEADO";
                    dNet.style.color = "#ff3333";
                    dErr.innerText = "Error: El AP bloquea la Nube.";
                }
            })();

            // 3. EVENTO DE CONEXIÓN
            btn.addEventListener('click', async () => {
                btn.disabled = true;
                statusBar.innerText = "Autenticando...";

                // COMBINACIÓN DE LLAVES Y PARÁMETROS
                const bodyData = {
                    ga_ap_mac: ga_ap_mac,
                    ga_cmac: ga_cmac,
                    ga_Qv: ga_Qv,
                    freeAccess: true,
                    // AQUÍ COMBINAMOS LAS VARIANTES DE LLAVE
                    api_key: KEY,
                    ga_pass: KEY,
                    ga_pwd: KEY,
                    ga_success_url: SUCCESS
                };

                try {
                    const response = await fetch(URL_API, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + KEY // Obligatorio para API V2
                        },
                        body: JSON.stringify(bodyData)
                    });

                    const resJson = await response.json();

                    if (response.ok) {
                        statusBar.innerText = "¡Éxito! Redirigiendo...";
                        statusBar.style.color = "#00ff41";
                        setTimeout(() => { window.location.href = SUCCESS; }, 1200);
                    } else {
                        dErr.innerText = "Server: " + (resJson.message || response.status);
                        statusBar.innerText = "Rechazado por Cambium.";
                        btn.disabled = false;
                    }
                } catch (err) {
                    dErr.innerText = "Fetch Error: " + err.message;
                    statusBar.innerText = "Fallo de conexión (Red).";
                    statusBar.style.color = "#ff3333";
                    btn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
