<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal WiFi León - V5 Final</title>
    <style>
        :root { --accent: #007bff; --bg: #0a0a0a; --card: #1a1a1a; --text: #eee; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .card { background: var(--card); padding: 30px; border-radius: 20px; text-align: center; width: 100%; max-width: 360px; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        h2 { margin: 0 0 10px 0; color: #fff; }
        .btn-acceso { background: linear-gradient(135deg, var(--accent) 0%, #0056b3 100%); color: white; border: none; padding: 18px; font-size: 18px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 15px; box-shadow: 0 4px 15px rgba(0,123,255,0.3); }
        .btn-acceso:disabled { background: #333; color: #777; box-shadow: none; cursor: not-allowed; }
        
        /* Debug Console */
        #debug-box { margin-top: 25px; padding: 15px; background: #000; color: #00ff41; font-family: 'Courier New', monospace; font-size: 10px; border: 1px solid #00ff41; border-radius: 8px; width: 100%; max-width: 360px; box-sizing: border-box; }
        .line { border-bottom: 1px solid #111; padding: 5px 0; display: flex; justify-content: space-between; align-items: flex-start; }
        .val { color: #fff; text-align: right; max-width: 65%; word-break: break-all; }
        #status-msg { font-size: 13px; margin-top: 15px; font-weight: bold; min-height: 18px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>WiFi León</h2>
        <p style="color: #888; font-size: 14px; margin-bottom: 20px;">Presiona el botón para obtener 50 minutos de navegación gratuita.</p>
        
        <button id="connectBtn" class="btn-acceso">CONECTAR AHORA</button>
        <div id="status-msg"></div>
    </div>

    <div id="debug-box">
        <div style="text-align:center; font-weight:bold; color:#00ff41; margin-bottom:10px; border-bottom: 1px solid #00ff41;">SISTEMA DE DIAGNÓSTICO V5</div>
        <div class="line"><span>AP MAC:</span> <span class="val" id="d-ap">Cargando...</span></div>
        <div class="line"><span>CLIENT MAC:</span> <span class="val" id="d-cm">Cargando...</span></div>
        <div class="line"><span>SESSION (ga_Qv):</span> <span class="val" id="d-qv">-</span></div>
        <div class="line"><span>NET TEST:</span> <span class="val" id="d-net">Verificando...</span></div>
        <div class="line"><span>DETALLE:</span> <span class="val" id="d-err" style="color: #ffea00;">Listo</span></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CONFIGURACIÓN MAESTRA ---
            const CONFIG = {
                KEY: "1ccf7c8b0813cd1cb25d766b2d98ef854e68fa4e1633e99f570ec300ee2ac7ae",
                API: "https://us-e1.api.cloud.cambiumnetworks.com/api/v2/easypass/external-portal/login",
                EXITO: "https://empleo.leon.gob.mx"
            };

            const btn = document.getElementById('connectBtn');
            const status = document.getElementById('status-msg');
            const dNet = document.getElementById('d-net');
            const dErr = document.getElementById('d-err');

            // 1. CAPTURA DE PARÁMETROS DE LA URL
            const params = new URLSearchParams(window.location.search);
            const ga_ap_mac = params.get('ga_ap_mac') || params.get('ap_mac') || "";
            const ga_cmac = params.get('ga_cmac') || params.get('client_mac') || "";
            // Priorizamos 's' que es el token estándar del e510
            const ga_Qv = params.get('s') || params.get('ga_Qv') || params.get('ga_request_id') || "";

            document.getElementById('d-ap').innerText = ga_ap_mac || "No detectado";
            document.getElementById('d-cm').innerText = ga_cmac || "No detectado";
            document.getElementById('d-qv').innerText = ga_Qv ? "TOKEN CAPTURADO" : "SIN SESIÓN";

            // 2. TEST DE RED (Verificar Walled Garden)
            (async () => {
                try {
                    // Usamos un fetch ligero para ver si el AP nos deja salir
                    const test = await fetch(CONFIG.API, { method: 'OPTIONS', mode: 'cors' });
                    dNet.innerText = "ALCANZABLE (OK)";
                    dNet.style.color = "#00ff41";
                } catch (e) {
                    dNet.innerText = "BLOQUEADO";
                    dNet.style.color = "#ff3333";
                    dErr.innerText = "Walled Garden bloqueando la API.";
                }
            })();

            // 3. PROCESO DE AUTENTICACIÓN
            btn.addEventListener('click', async () => {
                if (!ga_Qv) {
                    status.innerText = "Error: Falta el token de sesión.";
                    status.style.color = "#ff3333";
                    return;
                }

                btn.disabled = true;
                status.innerText = "Solicitando acceso a la nube...";
                status.style.color = "#fff";

                // TRIPLE COMBINACIÓN DE LLAVES (Máxima compatibilidad)
                const payload = {
                    ga_ap_mac: ga_ap_mac,
                    ga_cmac: ga_cmac,
                    ga_Qv: ga_Qv,
                    freeAccess: true,
                    api_key: CONFIG.KEY,
                    ga_pass: CONFIG.KEY,
                    ga_success_url: CONFIG.EXITO
                };

                try {
                    const response = await fetch(CONFIG.API, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + CONFIG.KEY
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        status.innerText = "¡Conectado! Redirigiendo...";
                        status.style.color = "#00ff41";
                        setTimeout(() => { window.location.href = CONFIG.EXITO; }, 1500);
                    } else {
                        dErr.innerText = "Cambium Error: " + (result.message || response.status);
                        status.innerText = "Acceso Denegado.";
                        btn.disabled = false;
                    }
                } catch (err) {
                    dErr.innerText = "Fetch Error: " + err.message;
                    status.innerText = "Error de Red Persistente.";
                    status.style.color = "#ff3333";
                    btn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
