<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WiFi León - Acceso Directo</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f4f4f4; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; width: 85%; max-width: 400px; }
        .btn-acceso { background-color: #007bff; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        .btn-acceso:disabled { background-color: #ccc; }
        #msg { margin-top: 15px; font-size: 14px; }
        
        /* Ventana de Debug */
        #debug-box { margin-top: 20px; padding: 10px; background: #333; color: #0f0; font-family: monospace; font-size: 10px; border-radius: 5px; width: 85%; max-width: 400px; text-align: left; overflow-x: auto; }
        .debug-title { font-weight: bold; border-bottom: 1px solid #444; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <div class="card">
        <h2>WiFi León</h2>
        <p>Presiona el botón para conectar</p>
        
        <button id="connectBtn" class="btn-acceso">CONECTAR AHORA</button>
        <p id="msg"></p>
    </div>

    <div id="debug-box">
        <span class="debug-title">DEBUG CONSOLE:</span>
        <div id="debug-content">Esperando datos...</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. CONFIGURACIÓN ---
            const API_KEY = "1ccf7c8b0813cd1cb25d766b2d98ef854e68fa4e1633e99f570ec300ee2ac7ae";
            const ENDPOINT = "https://us-e1.api.cloud.cambiumnetworks.com/api/v2/easypass/external-portal/login";
            
            const btn = document.getElementById('connectBtn');
            const msg = document.getElementById('msg');
            const debugContent = document.getElementById('debug-content');

            // --- 2. CAPTURA DE PARÁMETROS ---
            const urlParams = new URLSearchParams(window.location.search);
            
            // Según tu URL, el e510 manda estos nombres:
            const apMac = urlParams.get('ga_ap_mac') || "";
            const clientMac = urlParams.get('ga_cmac') || "";
            const sessionToken = urlParams.get('s') || urlParams.get('ga_Qv') || "";

            // Mostrar en la ventana de Debug
            debugContent.innerHTML = `
                <b>AP MAC:</b> ${apMac || 'No detectada'}<br>
                <b>CLIENT MAC:</b> ${clientMac || 'No detectada'}<br>
                <b>TOKEN (s):</b> ${sessionToken ? 'OK (Capturado)' : 'FALTANTE'}<br>
                <b>SSID:</b> ${urlParams.get('ga_ssid') || 'N/A'}
            `;

            // Si no hay token, avisar
            if (!sessionToken) {
                msg.innerHTML = "❌ Error: Sesión no detectada.<br>Por favor, reconéctate al WiFi.";
                msg.style.color = "red";
                btn.disabled = true;
            }

            // --- 3. LÓGICA DE ENVÍO ---
            btn.addEventListener('click', async function() {
                btn.disabled = true;
                btn.innerText = "Procesando...";
                msg.innerText = "Enviando autorización a Cambium...";
                msg.style.color = "#444";

                const payload = {
                    ga_ap_mac: apMac,
                    ga_cmac: clientMac,
                    ga_Qv: sessionToken,
                    freeAccess: true
                };

                try {
                    const response = await fetch(ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + API_KEY
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        msg.innerText = "¡Éxito! Conectado.";
                        msg.style.color = "green";
                        setTimeout(() => {
                            window.location.href = "https://empleo.leon.gob.mx";
                        }, 1000);
                    } else {
                        // Aquí verás por qué falla (si es 401, 400, etc)
                        msg.innerText = "Error " + response.status + ": " + (result.message || "No autorizado");
                        msg.style.color = "orange";
                        btn.disabled = false;
                        btn.innerText = "REINTENTAR";
                    }
                } catch (error) {
                    msg.innerText = "Error de red: No se pudo conectar con la nube.";
                    msg.style.color = "red";
                    btn.disabled = false;
                    btn.innerText = "REINTENTAR";
                }
            });
        });
    </script>
</body>
</html>
