<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WiFi León - Debug Mode</title>
    <style>
        body { font-family: sans-serif; background-color: #1a1a1a; color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: #2d2d2d; padding: 25px; border-radius: 12px; text-align: center; width: 100%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .btn-acceso { background-color: #00c853; color: white; border: none; padding: 15px; font-size: 18px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        .btn-acceso:disabled { background-color: #555; cursor: not-allowed; }
        
        /* Consola de Debug Estilo Matrix */
        #debug-box { margin-top: 20px; padding: 15px; background: #000; color: #00ff41; font-family: 'Courier New', monospace; font-size: 11px; border: 1px solid #00ff41; border-radius: 5px; width: 100%; max-width: 400px; box-sizing: border-box; }
        .debug-line { margin-bottom: 5px; border-bottom: 1px dashed #004400; padding-bottom: 2px; }
        .status-tag { font-weight: bold; color: #fff; background: #d50000; padding: 2px 5px; border-radius: 3px; }
        .status-ok { background: #00c853; }
    </style>
</head>
<body>

    <div class="card">
        <h3>Portal WiFi León</h3>
        <p style="font-size: 14px; color: #bbb;">Validación de Acceso Externo</p>
        <button id="connectBtn" class="btn-acceso">CONECTAR AHORA</button>
        <p id="msg" style="font-size: 13px; margin-top: 10px;"></p>
    </div>

    <div id="debug-box">
        <div style="text-align: center; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #00ff41;">SISTEMA DE MONITOREO V2</div>
        <div id="debug-content">Iniciando escaneo de parámetros...</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_KEY = "1ccf7c8b0813cd1cb25d766b2d98ef854e68fa4e1633e99f570ec300ee2ac7ae";
            const ENDPOINT = "https://us-e1.api.cloud.cambiumnetworks.com/api/v2/easypass/external-portal/login";
            const SUCCESS_URL = "https://empleo.leon.gob.mx";

            const btn = document.getElementById('connectBtn');
            const msg = document.getElementById('msg');
            const debugContent = document.getElementById('debug-content');

            // 1. CAPTURA DE PARÁMETROS (Mapeo Universal)
            const urlParams = new URLSearchParams(window.location.search);
            
            const ga_ap_mac = urlParams.get('ga_ap_mac') || urlParams.get('ap_mac') || "NO DETECTADO";
            const ga_cmac = urlParams.get('ga_cmac') || urlParams.get('client_mac') || "NO DETECTADO";
            const ga_Qv = urlParams.get('s') || urlParams.get('ga_Qv') || urlParams.get('ga_request_id') || "";
            const freeAccess = "true";
            
            // 2. ACTUALIZAR VENTANA DE DEBUG
            const hasToken = ga_Qv !== "" ? '<span class="status-tag status-ok">OK</span>' : '<span class="status-tag">FALTANTE</span>';
            
            debugContent.innerHTML = `
                <div class="debug-line"><b>ga_ap_mac:</b> ${ga_ap_mac}</div>
                <div class="debug-line"><b>ga_cmac:</b> ${ga_cmac}</div>
                <div class="debug-line"><b>ga_Qv:</b> ${ga_Qv.substring(0,15)}... ${hasToken}</div>
                <div class="debug-line"><b>Api_key:</b> ${API_KEY.substring(0,10)}... <span class="status-tag status-ok">CARGADA</span></div>
                <div class="debug-line"><b>Freeaccess:</b> ${freeAccess}</div>
                <div class="debug-line"><b>ga_success_url:</b> ${SUCCESS_URL}</div>
                <div class="debug-line"><b>Header Auth:</b> Bearer + KEY <span class="status-tag status-ok">LISTO</span></div>
            `;

            if (ga_Qv === "") {
                msg.innerText = "Esperando parámetros del Access Point...";
                btn.disabled = true;
            }

            // 3. PROCESO DE LOGUEO
            btn.addEventListener('click', async function() {
                btn.disabled = true;
                btn.innerText = "AUTENTICANDO...";
                msg.style.color = "#00ff41";
                msg.innerText = "Enviando Header y Payload...";

                const payload = {
                    ga_ap_mac: ga_ap_mac,
                    ga_cmac: ga_cmac,
                    ga_Qv: ga_Qv,
                    ga_pass: API_KEY, // Enviado como parámetro adicional (ga_pass)
                    freeAccess: true,
                    ga_success_url: SUCCESS_URL
                };

                try {
                    const response = await fetch(ENDPOINT, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + API_KEY // El Header que pide V2
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        msg.innerText = "¡ACCESO CONCEDIDO! REDIRIGIENDO...";
                        setTimeout(() => { window.location.href = SUCCESS_URL; }, 1500);
                    } else {
                        msg.style.color = "#ff4444";
                        msg.innerText = "ERROR " + response.status + ": " + (result.message || "Invalid Key");
                        btn.disabled = false;
                        btn.innerText = "REINTENTAR";
                    }
                } catch (error) {
                    msg.style.color = "#ff4444";
                    msg.innerText = "ERROR DE RED: Bloqueo de Walled Garden o DNS.";
                    btn.disabled = false;
                    btn.innerText = "REINTENTAR";
                }
            });
        });
    </script>
</body>
</html>
